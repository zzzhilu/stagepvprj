# ğŸš€ R2 è¦–é »ç®¡ç†å•é¡Œ - å¿«é€Ÿä¿®å¾©æŒ‡å—

## ğŸ“Œ å•é¡Œæ‘˜è¦

**ç—‡ç‹€ï¼š** ä¸Šå‚³å½±ç‰‡åˆ° R2 æˆåŠŸï¼Œä½†å…§å®¹ç®¡ç†åˆ—è¡¨æ²’æœ‰é¡¯ç¤º

**æ ¹æœ¬åŸå› ï¼š** Zustand ç‹€æ…‹æ›´æ–°èˆ‡ Firestore ä¿å­˜ä¹‹é–“çš„ç«¶æ…‹æ¢ä»¶

**ä¿®å¾©ç‹€æ…‹ï¼š** âœ… å·²ä¿®å¾©

---

## âš¡ å¿«é€Ÿä¿®å¾©æª¢æŸ¥æ¸…å–®

### ç¬¬ä¸€æ­¥ï¼šç¢ºèªä¿®å¾©å·²æ‡‰ç”¨ âœ…

ä¿®æ”¹çš„æ–‡ä»¶ï¼š`src/components/client/R2VideoManager.tsx`

æª¢æŸ¥ä»¥ä¸‹ä¸‰å€‹ä½ç½®æ˜¯å¦ä½¿ç”¨äº† `setTimeout`ï¼š

1. **ä¸Šå‚³æˆåŠŸå¾Œ** (ç´„ç¬¬ 104-107 è¡Œ)
```typescript
setTimeout(() => {
    onSave?.();
}, 100);
```

2. **åˆªé™¤æˆåŠŸå¾Œ** (ç´„ç¬¬ 166-169 è¡Œ)
```typescript
setTimeout(() => {
    onSave?.();
}, 100);
```

3. **éŒ¯èª¤å¼·åˆ¶åˆªé™¤å¾Œ** (ç´„ç¬¬ 188-191 è¡Œ)
```typescript
setTimeout(() => {
    onSave?.();
}, 100);
```

### ç¬¬äºŒæ­¥ï¼šæ¸…é™¤èˆŠæ•¸æ“š

```javascript
// åœ¨ç€è¦½å™¨ Console (F12) ä¸­åŸ·è¡Œ
localStorage.clear()
// ç„¶å¾Œåˆ·æ–°é é¢
```

### ç¬¬ä¸‰æ­¥ï¼šæ¸¬è©¦ä¸Šå‚³

1. é€²å…¥å½±åƒé€²åº¦å°ˆæ¡ˆ
2. ä¸Šå‚³ä¸€å€‹æ¸¬è©¦å½±ç‰‡
3. ç¢ºèªåˆ—è¡¨ä¸­é¡¯ç¤ºæ–°å½±ç‰‡
4. åˆ·æ–°é é¢ï¼Œç¢ºèªå½±ç‰‡ä»ç„¶å­˜åœ¨

---

## ğŸ”§ è¨ºæ–·å·¥å…·ï¼ˆå¯é¸ï¼‰

### å•Ÿç”¨è¨ºæ–·é¢æ¿

1. ç·¨è¼¯ `src/app/video-progress/[id]/page.tsx`
2. æ·»åŠ å°å…¥ï¼š
   ```typescript
   import { R2VideoDebugPanel } from '@/components/debug/R2VideoDebugPanel';
   ```
3. åœ¨ `return` ä¸­æ·»åŠ ï¼š
   ```typescript
   {process.env.NODE_ENV === 'development' && <R2VideoDebugPanel />}
   ```
4. é‡å•Ÿé–‹ç™¼æœå‹™å™¨

**ä½ç½®ï¼š** é é¢å³ä¸‹è§’æœƒå‡ºç¾ã€ŒğŸ”§ è¨ºæ–·ã€æŒ‰éˆ•

**åŠŸèƒ½ï¼š**
- å¯¦æ™‚æŸ¥çœ‹ R2Videos ç‹€æ…‹
- æª¢æŸ¥æ•¸æ“šåŒæ­¥æƒ…æ³
- è¼¸å‡ºè¨ºæ–·ä¿¡æ¯åˆ° Console

---

## ğŸ› ä»ç„¶æœ‰å•é¡Œï¼Ÿ

### æª¢æŸ¥ç’°å¢ƒè®Šæ•¸

ç¢ºèªä»¥ä¸‹ç’°å¢ƒè®Šæ•¸å·²è¨­ç½®ï¼š

```env
R2_ACCOUNT_ID=xxxxx
R2_ACCESS_KEY_ID=xxxxx
R2_SECRET_ACCESS_KEY=xxxxx
R2_BUCKET_NAME=xxxxx
NEXT_PUBLIC_R2_PUBLIC_URL=https://xxxxx
```

**é©—è­‰æ–¹æ³•ï¼š**
- æª¢æŸ¥ `.env.local` æ–‡ä»¶
- åœ¨ Vercel/éƒ¨ç½²å¹³å°æª¢æŸ¥ç’°å¢ƒè®Šæ•¸è¨­ç½®

### æª¢æŸ¥ Console éŒ¯èª¤

æ‰“é–‹ç€è¦½å™¨é–‹ç™¼è€…å·¥å…· (F12) â†’ Console

**å¸¸è¦‹éŒ¯èª¤ï¼š**

1. **"Failed to get upload URL"**
   - æª¢æŸ¥ R2 API Token æ˜¯å¦æ­£ç¢º
   - ç¢ºèª R2_ACCOUNT_ID æ­£ç¢º

2. **"Failed to delete from R2"**
   - æª¢æŸ¥ API Token æ¬Šé™
   - ç¢ºèªæœ‰ Delete æ¬Šé™

3. **"Network Error"**
   - æª¢æŸ¥ç¶²çµ¡é€£æ¥
   - ç¢ºèª CORS è¨­ç½®

### æª¢æŸ¥ Network è«‹æ±‚

é–‹ç™¼è€…å·¥å…· â†’ Network â†’ éæ¿¾ "r2-upload"

**æˆåŠŸçš„è«‹æ±‚æ‡‰è©²ï¼š**
- POST `/api/r2-upload` â†’ ç‹€æ…‹ 200
- è¿”å›ï¼š`{ uploadUrl, publicUrl, videoId, filename, key }`

### æª¢æŸ¥ Firestore

1. Firebase Console â†’ Firestore Database
2. æ‰¾åˆ°å°æ‡‰çš„ project æ–‡æª”
3. æª¢æŸ¥ `r2Videos` æ¬„ä½æ˜¯å¦å­˜åœ¨
4. ç¢ºèªæ•¸æ“šçµæ§‹æ­£ç¢ºï¼š
   ```json
   {
     "r2Videos": [
       {
         "id": "vid_xxxxx",
         "filename": "test.mp4",
         "r2_url": "https://...",
         "uploadedAt": 1234567890
       }
     ]
   }
   ```

---

## ğŸ“š è©³ç´°æ–‡æª”

æ‰€æœ‰è©³ç´°æ–‡æª”ä½æ–¼ `.gemini/diagnostics/` ç›®éŒ„ï¼š

1. **r2_fix_summary.md** - å®Œæ•´ä¿®å¾©ç¸½çµ
2. **r2_video_fix_report.md** - è©³ç´°ä¿®å¾©å ±å‘Š
3. **r2_debug_panel_guide.md** - è¨ºæ–·å·¥å…·ä½¿ç”¨æŒ‡å—
4. **r2_env_checklist.md** - ç’°å¢ƒè®Šæ•¸æª¢æŸ¥æ¸…å–®
5. **r2_quick_reference.md** - æœ¬æ–‡ä»¶

---

## ğŸ’¡ é‡è¦æç¤º

### ä¿®æ”¹ç’°å¢ƒè®Šæ•¸å¾Œ
```bash
# å¿…é ˆé‡å•Ÿé–‹ç™¼æœå‹™å™¨
ctrl+c  # åœæ­¢
npm run dev  # é‡æ–°å•Ÿå‹•
```

### æ¸¬è©¦æ™‚å»ºè­°
1. ä½¿ç”¨å°æª”æ¡ˆï¼ˆ< 10MBï¼‰
2. ä½¿ç”¨å¸¸è¦‹æ ¼å¼ï¼ˆMP4, WebMï¼‰
3. ç¢ºä¿ç¶²çµ¡ç©©å®š

### éƒ¨ç½²å‰ç¢ºèª
- [ ] ç’°å¢ƒè®Šæ•¸å·²è¨­ç½®
- [ ] æœ¬åœ°æ¸¬è©¦é€šé
- [ ] Firestore è¦å‰‡æ­£ç¢º
- [ ] R2 CORS é…ç½®æ­£ç¢º

---

## ğŸ†˜ éœ€è¦å¹«åŠ©ï¼Ÿ

å¦‚æœä»¥ä¸Šæ­¥é©Ÿéƒ½ç„¡æ³•è§£æ±ºå•é¡Œï¼Œè«‹æ”¶é›†ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **ç€è¦½å™¨ Console æˆªåœ–** (åŒ…å«éŒ¯èª¤è¨Šæ¯)
2. **è¨ºæ–·é¢æ¿æ•¸æ“š** (é»æ“Šã€ŒğŸ“„ è¤‡è£½ JSONã€)
3. **Network è«‹æ±‚è©³æƒ…** (r2-upload è«‹æ±‚çš„ Response)
4. **Firestore æ•¸æ“šæˆªåœ–** (å°ˆæ¡ˆæ–‡æª”å…§å®¹)

---

**ä¿®å¾©æ—¥æœŸï¼š** 2026-02-03  
**ç‰ˆæœ¬ï¼š** 1.0  
**ç‹€æ…‹ï¼š** å¾…ç”¨æˆ¶é©—è­‰  

## âœ… æˆåŠŸæ¨™æº–

ä¿®å¾©æˆåŠŸå¾Œï¼Œæ‚¨æ‡‰è©²èƒ½å¤ ï¼š

- âœ… ä¸Šå‚³å½±ç‰‡å¾Œç«‹å³åœ¨åˆ—è¡¨çœ‹åˆ°
- âœ… åˆ·æ–°é é¢å¾Œå½±ç‰‡ä»ç„¶å­˜åœ¨
- âœ… é»æ“Šã€Œæ’­æ”¾ã€å¯ä»¥é è¦½å½±ç‰‡
- âœ… é»æ“Šã€Œåˆ†äº«ã€å¯ä»¥è¤‡è£½åˆ†äº«é€£çµ
- âœ… åœ¨æ–°é é¢æ‰“é–‹åˆ†äº«é€£çµå¯ä»¥æ’­æ”¾å½±ç‰‡
- âœ… åˆªé™¤å½±ç‰‡å¾Œåˆ—è¡¨æ­£ç¢ºæ›´æ–°

---

**ç¥æ‚¨æ¸¬è©¦é †åˆ©ï¼** ğŸ‰
