<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R2 è¦–é »è¨ºæ–·å·¥å…·</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        h1 {
            color: #60a5fa;
            border-bottom: 2px solid #60a5fa;
            padding-bottom: 10px;
        }
        .section {
            background: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .section h2 {
            color: #fbbf24;
            margin-top: 0;
        }
        input, textarea {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: #1a1a1a;
            border: 1px solid #404040;
            border-radius: 4px;
            color: #e0e0e0;
            font-family: monospace;
        }
        button {
            background: #60a5fa;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
        }
        button:hover {
            background: #3b82f6;
        }
        button.danger {
            background: #ef4444;
        }
        button.danger:hover {
            background: #dc2626;
        }
        .result {
            background: #1a1a1a;
            border: 1px solid #404040;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            color: #10b981;
        }
        .error {
            color: #ef4444;
        }
        .warning {
            color: #fbbf24;
        }
        .info {
            color: #60a5fa;
        }
        video {
            max-width: 100%;
            background: #000;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ R2 è¦–é »è¨ºæ–·å·¥å…·</h1>
    
    <div class="section">
        <h2>ğŸ“ æ­¥é©Ÿ 1: æª¢æŸ¥ç’°å¢ƒè®Šæ•¸</h2>
        <p>åœ¨ Console ä¸­åŸ·è¡Œä»¥ä¸‹å‘½ä»¤ï¼ŒæŸ¥çœ‹ R2 Public URLï¼š</p>
        <div class="result">console.log(process.env.NEXT_PUBLIC_R2_PUBLIC_URL);</div>
        <p class="info">å¦‚æœé¡¯ç¤º undefinedï¼Œè«‹æª¢æŸ¥ .env.local æ–‡ä»¶ä¸¦é‡å•Ÿé–‹ç™¼æœå‹™å™¨ã€‚</p>
    </div>

    <div class="section">
        <h2>ğŸŒ æ­¥é©Ÿ 2: æ¸¬è©¦ R2 è¦–é » URL</h2>
        <p>å¾è¨ºæ–·é¢æ¿æˆ– Console è¤‡è£½æ‚¨çš„ R2 è¦–é » URLï¼š</p>
        <input type="text" id="videoUrl" placeholder="https://your-r2-domain.com/videos/vid_xxxxx/video.mp4" />
        <button onclick="testVideoUrl()">æ¸¬è©¦ URL</button>
        <button onclick="testCORS()">æ¸¬è©¦ CORS</button>
        <div id="urlTestResult"></div>
    </div>

    <div class="section">
        <h2>ğŸ“¹ æ­¥é©Ÿ 3: è¦–é »æ’­æ”¾æ¸¬è©¦</h2>
        <button onclick="loadVideo()">è¼‰å…¥ä¸¦æ’­æ”¾è¦–é »</button>
        <button class="danger" onclick="clearVideo()">æ¸…é™¤</button>
        <div id="videoContainer"></div>
        <div id="playbackResult"></div>
    </div>

    <div class="section">
        <h2>ğŸ” æ­¥é©Ÿ 4: CORS è©³ç´°æª¢æŸ¥</h2>
        <button onclick="checkDetailedCORS()">åŸ·è¡Œ CORS æª¢æŸ¥</button>
        <div id="corsResult"></div>
    </div>

    <div class="section">
        <h2>ğŸ’¡ è¨ºæ–·å»ºè­°</h2>
        <div id="suggestions" class="result">
ç­‰å¾…è¨ºæ–·çµæœ...
        </div>
    </div>

    <script>
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const className = type;
            const icon = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸',
                info: 'â„¹ï¸'
            }[type] || 'â„¹ï¸';
            
            element.innerHTML += `<div class="${className}">${icon} ${message}</div>`;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        async function testVideoUrl() {
            const url = document.getElementById('videoUrl').value.trim();
            clearLog('urlTestResult');
            
            if (!url) {
                log('urlTestResult', 'è«‹è¼¸å…¥ R2 è¦–é » URL', 'warning');
                return;
            }

            log('urlTestResult', `æ¸¬è©¦ URL: ${url}`, 'info');

            try {
                const response = await fetch(url, { method: 'HEAD' });
                
                log('urlTestResult', `HTTP ç‹€æ…‹: ${response.status} ${response.statusText}`, 
                    response.ok ? 'success' : 'error');

                if (response.ok) {
                    const contentType = response.headers.get('Content-Type');
                    const contentLength = response.headers.get('Content-Length');
                    const corsHeader = response.headers.get('Access-Control-Allow-Origin');
                    
                    log('urlTestResult', `Content-Type: ${contentType || 'æœªè¨­ç½®'}`, 
                        contentType?.startsWith('video/') ? 'success' : 'warning');
                    
                    log('urlTestResult', `æª”æ¡ˆå¤§å°: ${contentLength ? (parseInt(contentLength) / 1024 / 1024).toFixed(2) + ' MB' : 'æœªçŸ¥'}`, 'info');
                    
                    log('urlTestResult', `CORS Header: ${corsHeader || 'âŒ æœªè¨­ç½®'}`, 
                        corsHeader ? 'success' : 'error');
                    
                    if (!corsHeader) {
                        updateSuggestions('CORS æ¨™é ­æœªè¨­ç½®ï¼è«‹åœ¨ R2 Bucket è¨­ç½®ä¸­é…ç½® CORS Policyã€‚');
                    }
                } else {
                    log('urlTestResult', `ç„¡æ³•è¨ªå•è¦–é »ã€‚å¯èƒ½åŸå› ï¼š\n1. URL ä¸æ­£ç¢º\n2. Public Access æœªå•Ÿç”¨\n3. æ–‡ä»¶ä¸å­˜åœ¨`, 'error');
                    updateSuggestions('URL ç„¡æ³•è¨ªå•ï¼è«‹æª¢æŸ¥ R2 Public Access è¨­ç½®å’Œ URL æ ¼å¼ã€‚');
                }
            } catch (error) {
                log('urlTestResult', `è«‹æ±‚å¤±æ•—: ${error.message}`, 'error');
                if (error.message.includes('CORS')) {
                    log('urlTestResult', 'é€™æ˜¯ CORS éŒ¯èª¤ï¼è«‹é…ç½® R2 Bucket çš„ CORS Policyã€‚', 'error');
                    updateSuggestions('CORS éŒ¯èª¤ï¼é€™æ˜¯æœ€å¸¸è¦‹çš„å•é¡Œã€‚è«‹åƒè€ƒä¿®å¾©æŒ‡å—é…ç½® CORSã€‚');
                }
            }
        }

        async function testCORS() {
            const url = document.getElementById('videoUrl').value.trim();
            clearLog('urlTestResult');
            
            if (!url) {
                log('urlTestResult', 'è«‹è¼¸å…¥ R2 è¦–é » URL', 'warning');
                return;
            }

            log('urlTestResult', 'åŸ·è¡Œ CORS æ¸¬è©¦...', 'info');

            try {
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors',
                });
                
                log('urlTestResult', 'CORS æ¸¬è©¦é€šéï¼æ‚¨çš„ R2 Bucket CORS è¨­ç½®æ­£ç¢ºã€‚', 'success');
                updateSuggestions('CORS é…ç½®æ­£å¸¸ã€‚å¦‚æœè¦–é »ä»ç„¡æ³•æ’­æ”¾ï¼Œè«‹æª¢æŸ¥è¦–é »æ ¼å¼å’Œç·¨ç¢¼ã€‚');
            } catch (error) {
                log('urlTestResult', `CORS æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                log('urlTestResult', 'è«‹åœ¨ Cloudflare R2 Dashboard é…ç½® CORS Policyã€‚', 'error');
                updateSuggestions('CORS æœªé…ç½®æˆ–é…ç½®ä¸æ­£ç¢ºï¼è«‹ç«‹å³é…ç½® CORS Policyã€‚');
            }
        }

        function loadVideo() {
            const url = document.getElementById('videoUrl').value.trim();
            const container = document.getElementById('videoContainer');
            clearLog('playbackResult');
            
            if (!url) {
                log('playbackResult', 'è«‹è¼¸å…¥ R2 è¦–é » URL', 'warning');
                return;
            }

            log('playbackResult', 'æ­£åœ¨è¼‰å…¥è¦–é »...', 'info');

            // å‰µå»ºè¦–é »å…ƒç´ 
            const video = document.createElement('video');
            video.src = url;
            video.controls = true;
            video.crossOrigin = 'anonymous';
            video.loop = true;
            video.style.width = '100%';
            video.style.marginTop = '10px';

            // äº‹ä»¶ç›£è½
            video.addEventListener('loadedmetadata', () => {
                log('playbackResult', `âœ… è¦–é »å…ƒæ•¸æ“šå·²è¼‰å…¥`, 'success');
                log('playbackResult', `æ™‚é•·: ${video.duration.toFixed(2)}ç§’`, 'info');
                log('playbackResult', `å°ºå¯¸: ${video.videoWidth}x${video.videoHeight}`, 'info');
            });

            video.addEventListener('canplay', () => {
                log('playbackResult', 'âœ… è¦–é »å¯ä»¥æ’­æ”¾', 'success');
                updateSuggestions('è¦–é »å¯ä»¥æ­£å¸¸æ’­æ”¾ï¼å¦‚æœåœ¨æ‡‰ç”¨ä¸­ç„¡æ³•æ’­æ”¾ï¼Œè«‹æª¢æŸ¥æ‡‰ç”¨ä»£ç¢¼ã€‚');
            });

            video.addEventListener('error', (e) => {
                log('playbackResult', `âŒ è¦–é »è¼‰å…¥éŒ¯èª¤: ${video.error?.message || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                log('playbackResult', `éŒ¯èª¤ä»£ç¢¼: ${video.error?.code}`, 'error');
                
                if (video.error?.code === 4) {
                    log('playbackResult', 'å¯èƒ½åŸå› ï¼šè¦–é »æ ¼å¼ä¸æ”¯æŒæˆ–æ–‡ä»¶æå£', 'warning');
                }
            });

            video.addEventListener('playing', () => {
                log('playbackResult', 'â–¶ï¸ è¦–é »æ­£åœ¨æ’­æ”¾', 'success');
            });

            container.innerHTML = '';
            container.appendChild(video);

            // å˜—è©¦æ’­æ”¾
            video.play().then(() => {
                log('playbackResult', 'âœ… è‡ªå‹•æ’­æ”¾æˆåŠŸ', 'success');
            }).catch(err => {
                log('playbackResult', `âš ï¸ è‡ªå‹•æ’­æ”¾è¢«é˜»æ“‹: ${err.message}`, 'warning');
                log('playbackResult', 'é€™æ˜¯æ­£å¸¸çš„ç€è¦½å™¨è¡Œç‚ºï¼Œè«‹æ‰‹å‹•é»æ“Šæ’­æ”¾ã€‚', 'info');
            });
        }

        function clearVideo() {
            document.getElementById('videoContainer').innerHTML = '';
            clearLog('playbackResult');
            log('playbackResult', 'å·²æ¸…é™¤è¦–é »', 'info');
        }

        async function checkDetailedCORS() {
            const url = document.getElementById('videoUrl').value.trim();
            clearLog('corsResult');
            
            if (!url) {
                log('corsResult', 'è«‹è¼¸å…¥ R2 è¦–é » URL', 'warning');
                return;
            }

            log('corsResult', 'åŸ·è¡Œè©³ç´° CORS æª¢æŸ¥...', 'info');
            log('corsResult', `ç•¶å‰ä¾†æº: ${window.location.origin}`, 'info');

            try {
                const response = await fetch(url);
                
                const headers = [
                    'Access-Control-Allow-Origin',
                    'Access-Control-Allow-Methods',
                    'Access-Control-Allow-Headers',
                    'Access-Control-Expose-Headers',
                    'Access-Control-Max-Age',
                    'Content-Type',
                    'Content-Length'
                ];

                log('corsResult', '\nResponse Headers:', 'info');
                headers.forEach(header => {
                    const value = response.headers.get(header);
                    log('corsResult', `${header}: ${value || 'âŒ æœªè¨­ç½®'}`, 
                        value ? 'success' : 'warning');
                });

                const allowOrigin = response.headers.get('Access-Control-Allow-Origin');
                if (allowOrigin === '*' || allowOrigin === window.location.origin) {
                    log('corsResult', '\nâœ… CORS é…ç½®æ­£ç¢ºï¼', 'success');
                } else if (!allowOrigin) {
                    log('corsResult', '\nâŒ CORS æœªé…ç½®ï¼', 'error');
                    updateSuggestions('CORS æœªé…ç½®ï¼è«‹ç«‹å³åœ¨ R2 Bucket è¨­ç½®ä¸­æ·»åŠ  CORS Policyã€‚');
                } else {
                    log('corsResult', `\nâš ï¸ CORS é…ç½®äº†ï¼Œä½†ä¸åŒ¹é…ç•¶å‰ä¾†æº`, 'warning');
                    log('corsResult', `å…è¨±çš„ä¾†æº: ${allowOrigin}`, 'warning');
                    log('corsResult', `ç•¶å‰ä¾†æº: ${window.location.origin}`, 'warning');
                }
            } catch (error) {
                log('corsResult', `CORS æª¢æŸ¥å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function updateSuggestions(message) {
            const element = document.getElementById('suggestions');
            element.innerHTML = `<div class="warning">âš ï¸ ${message}</div>`;
            
            element.innerHTML += `\n\n<strong>ä¿®å¾©æ­¥é©Ÿï¼š</strong>\n`;
            element.innerHTML += `1. é€²å…¥ Cloudflare Dashboard â†’ R2 â†’ æ‚¨çš„ Bucket\n`;
            element.innerHTML += `2. é»æ“Š Settings â†’ CORS Policy â†’ Edit CORS Policy\n`;
            element.innerHTML += `3. æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š\n\n`;
            element.innerHTML += `<div class="result">[
  {
    "AllowedOrigins": ["*"],
    "AllowedMethods": ["GET", "HEAD"],
    "AllowedHeaders": ["*"],
    "MaxAgeSeconds": 3600
  }
]</div>\n`;
            element.innerHTML += `4. åŒæ™‚ç¢ºä¿ Public Access å·²å•Ÿç”¨\n`;
            element.innerHTML += `5. é‡å•Ÿé–‹ç™¼æœå‹™å™¨ä¸¦æ¸¬è©¦\n`;
        }
    </script>
</body>
</html>
